// ==UserScript==
// @name        Gamma Entertainment - Scene Length
// @author      peolic
// @version     1.2
// @description Add scene length information on Gamma Entertainment sites
// @icon        https://www.gammaentertainment.com/images/logo_gammae.png
// @namespace   https://github.com/peolic
// @match       https://*.21members.com/*
// @match       https://*.21naturals.com/*
// @match       https://*.21sextreme.com/*
// @match       https://*.21sextury.com/*
// @match       https://*.21sexxxturyclub.com/*
// @match       https://*.21token.com/*
// @match       https://*.3rddegreefilms.com/*
// @match       https://*.aaliyahlove.com/*
// @match       https://*.abbeybrooks.com/*
// @match       https://*.activeduty.com/*
// @match       https://*.addicted2girls.com/*
// @match       https://*.adrianachechikvideos.com/*
// @match       https://*.adulttime.com/*
// @match       https://*.adulttime.xxx/*
// @match       https://*.ageandbeauty.com/*
// @match       https://*.agentredgirl.com/*
// @match       https://*.alettaoceanempire.com/*
// @match       https://*.allblackx.com/*
// @match       https://*.allgirlmassage.com/*
// @match       https://*.analteenangels.com/*
// @match       https://*.analtrixxx.com/*
// @match       https://*.anissakate.com/*
// @match       https://*.ashleyfires.com/*
// @match       https://*.asmrfantasy.com/*
// @match       https://*.assholefever.com/*
// @match       https://*.austinwilde.com/*
// @match       https://*.awesome21sextury.com/*
// @match       https://*.awolmarinesflix.com/*
// @match       https://*.barracksboys.com/*
// @match       https://*.bearback.com/*
// @match       https://*.bethecuck.com/*
// @match       https://*.biempire.com/*
// @match       https://*.bigbonerflix.com/*
// @match       https://*.bigfatcreampie.com/*
// @match       https://*.biphoria.com/*
// @match       https://*.bisexdigital.com/*
// @match       https://*.blazingbucks.com/*
// @match       https://*.blu-raydvdz.com/*
// @match       https://*.boyzparty.com/*
// @match       https://*.breeolson.com/*
// @match       https://*.bskow.com/*
// @match       https://*.bubblegumdungeon.com/*
// @match       https://*.buddydvdz.com/*
// @match       https://*.burningangel.com/*
// @match       https://*.burningangelflix.com/*
// @match       https://*.burningflix.com/*
// @match       https://*.bushybushy.com/*
// @match       https://*.buttman.com/*
// @match       https://*.cardiogasm.com/*
// @match       https://*.cassandracalogera.com/*
// @match       https://*.caughtfapping.com/*
// @match       https://*.chaosmen.com/*
// @match       https://*.cheersquadparties.com/*
// @match       https://*.cherrypop.com/*
// @match       https://*.christophclarkonline.com/*
// @match       https://*.christophsbignaturaltits.com/*
// @match       https://*.circlejerkboys.com/*
// @match       https://*.club21natural.com/*
// @match       https://*.club21naturals.com/*
// @match       https://*.club21sexxxtury.com/*
// @match       https://*.clubcuties.com/*
// @match       https://*.clubfantasymassage.com/*
// @match       https://*.clubinfernodungeon.com/*
// @match       https://*.clublaly.com/*
// @match       https://*.clubsextury.com/*
// @match       https://*.clubsextury21.com/*
// @match       https://*.clubsexxxtury21.com/*
// @match       https://*.cockchokingsluts.com/*
// @match       https://*.cocksuckingchallenge.com/*
// @match       https://*.cockvirgins.com/*
// @match       https://*.codycummings.com/*
// @match       https://*.couplesseekingteens.com/*
// @match       https://*.crazyporndvds.com/*
// @match       https://*.cumshotoasis.com/*
// @match       https://*.currycreampie.com/*
// @match       https://*.darkx.com/*
// @match       https://*.devilsfilm.com/*
// @match       https://*.devilsfilmparodies.com/*
// @match       https://*.devilsgangbangs.com/*
// @match       https://*.devilstgirls.com/*
// @match       https://*.devonlee.com/*
// @match       https://*.diabolic.com/*
// @match       https://*.disruptivefilms.com/*
// @match       https://*.doghousedigital.com/*
// @match       https://*.dpfanatics.com/*
// @match       https://*.dylanlucas.com/*
// @match       https://*.dylanryder.com/*
// @match       https://*.eroticax.com/*
// @match       https://*.euro-angels.com/*
// @match       https://*.evilangel.com/*
// @match       https://*.evilangelnetwork.com/*
// @match       https://*.extrabigdicks.com/*
// @match       https://*.extraxxxflix.com/*
// @match       https://*.falconstudios.com/*
// @match       https://*.famedigital.com/*
// @match       https://*.familycreep.com/*
// @match       https://*.familysexmassage.com/*
// @match       https://*.fantasymassage.com/*
// @match       https://*.femalesubmission.com/*
// @match       https://*.filthykings.com/*
// @match       https://*.fistingcentral.com/*
// @match       https://*.fistinginferno.com/*
// @match       https://*.flashyflix.com/*
// @match       https://*.footsiebabes.com/*
// @match       https://*.fuckbookflix.com/*
// @match       https://*.futasentaisquad.com/*
// @match       https://*.futuredarkly.com/*
// @match       https://*.gapingangels.com/*
// @match       https://*.gayallaccess.com/*
// @match       https://*.gaymilitaryflix.com/*
// @match       https://*.gaysuperporn.com/*
// @match       https://*.genderxfilms.com/*
// @match       https://*.girlcore.com/*
// @match       https://*.girlfriendsfilms.com/*
// @match       https://*.girlsandstuds.com/*
// @match       https://*.girlstryanal.com/*
// @match       https://*.girlsunderarrest.com/*
// @match       https://*.girlsway.com/*
// @match       https://*.givemeteens.com/*
// @match       https://*.goodxxxflix.com/*
// @match       https://*.grannyghetto.com/*
// @match       https://*.hairyundies.com/*
// @match       https://*.hannahilton.com/*
// @match       https://*.hardpornoflix.com/*
// @match       https://*.hardx.com/*
// @match       https://*.hentaisexschool.com/*
// @match       https://*.highperformancemen.com/*
// @match       https://*.hothouse.com/*
// @match       https://*.house21sextury.com/*
// @match       https://*.iconmale.com/*
// @match       https://*.iloveblackshemales.com/*
// @match       https://*.isthisreal.com/*
// @match       https://*.iswallowpeternorth.com/*
// @match       https://*.jakemalone.com/*
// @match       https://*.joannaangel.com/*
// @match       https://*.jocksstudios.com/*
// @match       https://*.joeysilvera.com/*
// @match       https://*.johnleslie.com/*
// @match       https://*.johnnyrapid.com/*
// @match       https://*.jonnidarkkoxxx.com/*
// @match       https://*.joymii.com/*
// @match       https://*.ladygonzo.com/*
// @match       https://*.lanesisters.com/*
// @match       https://*.latexplaytime.com/*
// @match       https://*.lesbianfactor.com/*
// @match       https://*.lesbianolderyounger.com/*
// @match       https://*.lesbianx.com/*
// @match       https://*.lewood.com/*
// @match       https://*.lexingtonsteele.com/*
// @match       https://*.lezcuties.com/*
// @match       https://*.lounge21sextury.com/*
// @match       https://*.lowartfilms.com/*
// @match       https://*.maledigital.com/*
// @match       https://*.malereality.com/*
// @match       https://*.manuelferrara.com/*
// @match       https://*.manybigflix.com/*
// @match       https://*.manyxxxflix.com/*
// @match       https://*.marcusmojo.com/*
// @match       https://*.maskurbate.com/*
// @match       https://*.masonwyler.com/*
// @match       https://*.massage-parlor.com/*
// @match       https://*.mega21sextury.com/*
// @match       https://*.menover30.com/*
// @match       https://*.mightyrods.com/*
// @match       https://*.mikeadriano.com/*
// @match       https://*.milehighmedia.com/*
// @match       https://*.milkingtable.com/*
// @match       https://*.mixedx.com/*
// @match       https://*.modeltime.com/*
// @match       https://*.moderndaysins.com/*
// @match       https://*.mommysboy.com/*
// @match       https://*.mommysgirl.com/*
// @match       https://*.motherdaughterexchangeclub.com/*
// @match       https://*.motherfuckerxxx.com/*
// @match       https://*.mypervyfamily.com/*
// @match       https://*.myteenoasis.com/*
// @match       https://*.nachovidalhardcore.com/*
// @match       https://*.nextdoorbuddies.com/*
// @match       https://*.nextdoorcasting.com/*
// @match       https://*.nextdoorebony.com/*
// @match       https://*.nextdoorhookups.com/*
// @match       https://*.nextdoormale.com/*
// @match       https://*.nextdoorraw.com/*
// @match       https://*.nextdoorstars.com/*
// @match       https://*.nextdoorstudios.com/*
// @match       https://*.nextdoortaboo.com/*
// @match       https://*.nextdoortwink.com/*
// @match       https://*.noirmale.com/*
// @match       https://*.nsexxxtra.com/*
// @match       https://*.nudefightclub.com/*
// @match       https://*.nudemaledancers.tv/*
// @match       https://*.nuruflix.com/*
// @match       https://*.nurumassage.com/*
// @match       https://*.onlygirlsxxx.com/*
// @match       https://*.openlife.com/*
// @match       https://*.openlifeflix.com/*
// @match       https://*.outofthefamily.com/*
// @match       https://*.pansexualx.com/*
// @match       https://*.pantypops.com/*
// @match       https://*.peternorth.com/*
// @match       https://*.peternorthdvd.com/*
// @match       https://*.pornerpremium.com/*
// @match       https://*.povblowjobs.com/*
// @match       https://*.povthis.com/*
// @match       https://*.prettydirty.com/*
// @match       https://*.pridegayflix.com/*
// @match       https://*.pridestudios.com/*
// @match       https://*.puretaboo.com/*
// @match       https://*.quebecproductions.com/*
// @match       https://*.ragingstallion.com/*
// @match       https://*.realityjunkies.com/*
// @match       https://*.roccosiffredi.com/*
// @match       https://*.roddaily.com/*
// @match       https://*.rodneyflix.com/*
// @match       https://*.samuelotoole.com/*
// @match       https://*.scaryfuckers.com/*
// @match       https://*.seemyflixxx.com/*
// @match       https://*.seemygayflix.com/*
// @match       https://*.sensflix.com/*
// @match       https://*.sexbookflix.com/*
// @match       https://*.sextapelesbians.com/*
// @match       https://*.sexturyclub.com/*
// @match       https://*.sexxxturyclub.com/*
// @match       https://*.shapeofbeauty.com/*
// @match       https://*.shemaleidol.com/*
// @match       https://*.shemalesflix.com/*
// @match       https://*.sheplayswithhercock.com/*
// @match       https://*.silverstonedvd.com/*
// @match       https://*.silviasaint.com/*
// @match       https://*.sistertrick.com/*
// @match       https://*.soapymassage.com/*
// @match       https://*.squirtalicious.com/*
// @match       https://*.squirtinglesbian.com/*
// @match       https://*.squirtingorgies.com/*
// @match       https://*.stagcollective.com/*
// @match       https://*.stockbarflix.com/*
// @match       https://*.strapattackers.com/*
// @match       https://*.strokethatdick.com/*
// @match       https://*.sunnyleone.com/*
// @match       https://*.super21sextury.com/*
// @match       https://*.sweetheartvideo.com/*
// @match       https://*.sweetsinner.com/*
// @match       https://*.tabooheat.com/*
// @match       https://*.terapatrick.com/*
// @match       https://*.thebrats.com/*
// @match       https://*.tittycreampies.com/*
// @match       https://*.tokenbuy.com/*
// @match       https://*.tommydxxx.com/*
// @match       https://*.touchmywife.com/*
// @match       https://*.trannypros.com/*
// @match       https://*.transfixed.com/*
// @match       https://*.transgressivexxx.com/*
// @match       https://*.transsensual.com/*
// @match       https://*.transsexualangel.com/*
// @match       https://*.transsexualroadtrip.com/*
// @match       https://*.trickyspa.com/*
// @match       https://*.truelesbian.com/*
// @match       https://*.trystanbull.com/*
// @match       https://*.tsfactor.com/*
// @match       https://*.ultimate21sextury.com/*
// @match       https://*.underthebed.com/*
// @match       https://*.viscontitriplets.com/*
// @match       https://*.vivid.com/*
// @match       https://*.webyoung.com/*
// @match       https://*.webyoungflix.com/*
// @match       https://*.wheretheboysarent.com/*
// @match       https://*.whiteghetto.com/*
// @match       https://*.wicked.com/*
// @match       https://*.wolfwagner.com/*
// @match       https://*.wolfwagner.xxx/*
// @match       https://*.xempire.com/*
// @match       https://*.zerotolerancefilms.com/*
// @grant       none
// @homepageURL https://github.com/peolic/userscripts
// @downloadURL https://raw.githubusercontent.com/peolic/userscripts/main/gamma-ent.user.js
// @updateURL   https://raw.githubusercontent.com/peolic/userscripts/main/gamma-ent.user.js
// ==/UserScript==

// list of domains from https://www.gammaentertainment.com/
// Array.from(document.querySelectorAll('.list-item')).map(e => `// @match       https://*.${e.innerText.trim()}/*`).join('\n')

// non-matching
// https://*.1000facials.com/*
// https://*.blowpass.com/*
// https://*.immorallive.com/*
// https://*.mommyblowsbest.com/*
// https://*.onlyteenblowjobs.com/*
// https://*.throated.com/*
// https://*.xxxpassflix.com/*


(async () => {

  async function main() {
    singleScene();
    sceneThumbs();
  }

  async function singleScene() {
    const sceneHeader = await elementReadyIn('.ScenePlayerHeaderDesktop-Container', 5000);
    if (!sceneHeader)
      return;

    const data = getReactFiber(sceneHeader)?.return?.return?.return?.return?.memoizedProps?.scene;
    if (!data) throw new Error('failed to get fiber');

    const date = sceneHeader.querySelector('.ScenePlayerHeaderDesktop-Date-Text');
    const length = date.cloneNode(true);
    const sep = (date.previousElementSibling || date.nextElementSibling).cloneNode(true);
    length.innerText = `⏱ ${data.length}`;
    length.title = data.length;
    date.after(sep, length);
  }

  async function sceneThumbs() {
    if (!await elementReadyIn('.SceneThumb-Default'))
      return;

    document.querySelectorAll('.SceneThumb-Default').forEach((sceneThumb) => {
      const data = getReactFiber(sceneThumb)?.child?.child?.memoizedProps?.scene;
      if (!data) throw new Error('failed to get fiber');

      const date = sceneThumb.querySelector('.SceneDetail-DatePublished-Text');
      const length = date.cloneNode(true);
      length.innerText = `⏱ ${data.length}`;
      length.title = data.length;
      date.before(length);
    });
  }

  // MIT Licensed
  // Author: jwilson8767
  // https://gist.github.com/jwilson8767/db379026efcbd932f64382db4b02853e
  /**
   * Waits for an element satisfying selector to exist, then resolves promise with the element.
   * Useful for resolving race conditions.
   *
   * @param {string} selector
   * @param {HTMLElement} [parentEl]
   * @returns {Promise<Element>}
   */
  function elementReady(selector, parentEl) {
    return new Promise((resolve, reject) => {
      let el = (parentEl || document).querySelector(selector);
      if (el) {resolve(el);}
      new MutationObserver((mutationRecords, observer) => {
        // Query for elements matching the specified selector
        Array.from((parentEl || document).querySelectorAll(selector)).forEach((element) => {
          resolve(element);
          //Once we have resolved we don't need the observer anymore.
          observer.disconnect();
        });
      })
      .observe(parentEl || document.documentElement, {
        childList: true,
        subtree: true
      });
    });
  }

  const wait = (/** @type {number} */ ms) => new Promise((resolve) => setTimeout(resolve, ms));

  /**
   * @param {string} selector
   * @param {number} [timeout] fail after, in milliseconds
   * @param {HTMLElement} [parentEl]
   */
  const elementReadyIn = (selector, timeout, parentEl) => {
    const promises = [elementReady(selector, parentEl)];
    if (timeout) promises.push(wait(timeout).then(() => null));
    return Promise.race(promises);
  };

  /**
   * @param {Element} el
   * @returns {Record<string, any> | undefined}
   */
  const getReactFiber = (el) =>
    //@ts-expect-error
    el[Object.getOwnPropertyNames(el).find((p) => p.startsWith('__reactFiber$'))];

  // Based on: https://dirask.com/posts/JavaScript-on-location-changed-event-on-url-changed-event-DKeyZj
  const locationChanged = (function() {
    const { pushState, replaceState } = history;

    // @ts-expect-error
    const prefix = GM.info.script.name
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9 -]/g, '')
      .replace(/\s+/g, '-');

    const eventName = `${prefix}$locationchange`;
    const makeLocationChangeEvent = (/** @type {string} */ source) => new CustomEvent(eventName, { detail: source });

    history.pushState = function(...args) {
      pushState.apply(history, args);
      window.dispatchEvent(makeLocationChangeEvent('pushState'));
    }

    history.replaceState = function(...args) {
      replaceState.apply(history, args);
      window.dispatchEvent(makeLocationChangeEvent('replaceState'));
    }

    window.addEventListener('popstate', function() {
      window.dispatchEvent(makeLocationChangeEvent('popstate'));
    });

    return eventName;
  })();

  window.addEventListener(locationChanged, () => {
    wait(200).then(main);
  });

  await main();

})();
